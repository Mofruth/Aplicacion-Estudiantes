<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Nota</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profesor.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-chalkboard-teacher"></i> Profesor</div>
            <nav>
                <a href="{{ url_for('profesor_dashboard') }}" class="{% if 'dashboard' in request.path %}active{% endif %}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="/profesor/obtener_estudiantes" class="{% if 'obtener_estudiantes' in request.path %}active{% endif %}">
                    <i class="fas fa-users"></i> Obtener Estudiantes
                </a>
                <a href="/profesor/asignar_nota" class="{% if 'asignar_nota' in request.path %}active{% endif %}">
                    <i class="fas fa-edit"></i> Asignar Nota
                </a>
                <a href="/profesor/cambiar_nota" class="{% if 'cambiar_nota' in request.path %}active{% endif %}">
                    <i class="fas fa-sync-alt"></i> Cambiar Nota
                </a>
                <a href="/profesor/enviar_notificacion" class="{% if 'enviar_notificacion' in request.path %}active{% endif %}">
                    <i class="fas fa-envelope"></i> Notificar
                </a>
            </nav>
            <a href="/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
        </aside>

        <main class="content">
            <div class="container">
                <h1>Asignar Nota</h1>
                
                <form method="POST" action="{{ url_for('asignar_nota') }}" id="formSeleccionMateria">
                    <label for="id_materia">Selecciona una materia:</label>
                    <select name="id_materia" id="id_materia" required style="padding:8px 12px; border-radius:6px; min-width:fit-content;">
                        <option value="">Seleccione una materia</option>
                        {% for materia in materias %}
                            <option value="{{ materia.id }}" {% if id_materia == materia.id|string %}selected{% endif %}>
                                {{ materia.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                    <div style="display:flex; justify-content:center; margin-top:16px;">
                        <button type="submit" style="padding:12px 28px; border-radius:8px; min-width:fit-content; background:#4facfe; color:white; border:none; width:fit-content; font-size:1.15rem; font-weight:500;">Buscar Estudiantes</button>
                    </div>
                </form>

                {% if estudiantes %}
                <form method="POST" action="{{ url_for('asignar_nota') }}" id="formAsignarNotas">
                    <input type="hidden" name="id_materia" value="{{ request.form.get('id_materia') }}">
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="tipo_evaluacion" style="font-weight: bold; margin-bottom: 0.8rem;">Tipo de Evaluación:</label>
                        <select name="tipo_evaluacion" id="tipo_evaluacion" required>
                            <option value="" disabled selected>-- Selecciona el tipo de evaluación --</option>
                            <option value="Parcial 1">Parcial 1</option>
                            <option value="Parcial 2">Parcial 2</option>
                            <option value="Parcial 3">Parcial 3</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Tarea">Tarea</option>
                            <option value="Proyecto">Proyecto</option>
                            <option value="Participación">Participación</option>
                            <option value="Examen Final">Examen Final</option>
                        </select>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Nombre del Estudiante</th>
                                <th>Correo</th>
                                <th>Nota (0-5)</th>
                                <th>Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for estudiante in estudiantes %}
                            <tr>
                                <td>{{ estudiante['estudiante'] }}</td>
                                <td>{{ estudiante['correo'] }}</td>
                                <td>
                                    <input class="nota-input" type="number" name="nota[]" min="0" max="5" step="0.1" required placeholder="0.0">
                                </td>
                                <td>
                                    <textarea class="comentario-textarea" name="comentario[]" rows="2" placeholder="Comentario..."></textarea>
                                </td>
                                <input type="hidden" name="id_estudiante[]" value="{{ estudiante['id'] }}">
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div style="display:flex; justify-content:center; margin-top:16px;">
                        <button type="submit" style="padding:12px 28px; border-radius:8px; min-width:fit-content; background:#4facfe; color:white; border:none; width:fit-content; font-size:1.15rem; font-weight:500;">Asignar Nota</button>
                    </div>
                </form>
                {% endif %}

                <div style="display: flex; justify-content: center; margin-top: 2rem;">
                    <a href="{{ url_for('profesor_dashboard') }}" style="text-decoration: none;">
                        <div style="display:flex; justify-content:center; margin-top:20px;">
                            <button type="button" class="btn-back" style="padding:12px 28px; border-radius:8px; min-width:fit-content; background:#747d87; color:white; border:none; width:fit-content; font-size:1.15rem; font-weight:500;">Volver al Dashboard</button>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoEvaluacionSelect = document.getElementById('tipo_evaluacion');
            const formAsignarNotas = document.getElementById('formAsignarNotas');

            // Recordar la selección de tipo de evaluación
            if (tipoEvaluacionSelect) {
                // Cargar valor guardado en localStorage si existe
                const tipoGuardado = localStorage.getItem('tipoEvaluacionSeleccionado');
                if (tipoGuardado) {
                    tipoEvaluacionSelect.value = tipoGuardado;
                }

                // Guardar selección cuando cambia
                tipoEvaluacionSelect.addEventListener('change', function() {
                    localStorage.setItem('tipoEvaluacionSeleccionado', this.value);
                });
            }

            // Validación antes de enviar
            if (formAsignarNotas) {
                formAsignarNotas.addEventListener('submit', function(e) {
                    if (!tipoEvaluacionSelect.value) {
                        e.preventDefault();
                        alert('Por favor, selecciona un tipo de evaluación');
                        tipoEvaluacionSelect.focus();
                        return false;
                    }

                    // Validar que al menos una nota esté completa
                    const notasInputs = document.querySelectorAll('.nota-input');
                    let tieneAlgunaNota = false;
                    notasInputs.forEach(input => {
                        if (input.value && parseFloat(input.value) >= 0) {
                            tieneAlgunaNota = true;
                        }
                    });

                    if (!tieneAlgunaNota) {
                        e.preventDefault();
                        alert('Por favor, ingresa al menos una nota');
                        return false;
                    }
                });
            }
        });
    </script>
</body>
</html>